<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kábel terhelhetőség</title>
<style>
  :root{--bg:#0b1220;--card:#101a2c;--text:#e6edff;--muted:#9fb0c7;--line:#243552}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1120px;margin:32px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.grid{grid-template-columns:1.2fr 1fr}}
  .card{background:linear-gradient(180deg,var(--card),#0e1626 45%);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0a1424;color:var(--text)}
  .pill{display:inline-block;background:#0a1c33;border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin-right:8px;color:var(--muted);font-size:12px}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .big{font-size:32px;font-weight:800;letter-spacing:.2px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#0c1c33;color:#dbe6ff;cursor:pointer}
  hr{border:0;border-top:1px dashed var(--line);margin:14px 0}
  details{margin-top:8px} summary{color:var(--muted);font-size:12px;cursor:pointer}
  code{background:#0c1830;padding:2px 6px;border-radius:6px;border:1px solid #1e2b47}
  .note{font-size:11px;color:#789; margin-top:12px;}
  /* --- Rendszer adatai státuszszínek --- */
.ok  { color:#4ade80; }  /* zöld */
.bad { color:#f87171; }  /* piros */

  .sources-actions{ margin-top:10px; }

  /* Segédletek gomb elválasztó és térköz */
.sources-actions{
  margin-top:14px;          /* kis hely a fenti tartalomtól */
  padding-top:12px;         /* hely a szaggatott vonal és a gomb között */
  border-top:1px dashed var(--line);  /* szaggatott elválasztó */
}



</style>
</head>
<body>
<div class="wrap">
  <h1>Földkábel terhelhetőség/Cable current capacity</h1>
  <div class="sub">A = <strong>Alapterhelhetőség/Base load</strong> × <strong>f1</strong> × <strong>f2</strong> </div>
  <div class="grid">
    <section class="card">
      <div class="pill">1. Alap</div>
      <label for="base">Alapterhelhetőség/Base load (A)</label>
      <input id="base" type="number" min="0" step="0.1" placeholder="pl. 250" />
      <hr />
      <div class="pill">2. f1 </div>
      <div class="row">
        <div>
          <label for="f1type">Kábel típusa/Cable type</label>
          <select id="f1type" title="Kábel típusa felhasználása az f1 táblázatban">
            <option value="XLPE90">90 °C – XLPE-szigetelésű</option>
            <option value="PVC70">70 °C – PVC-szigetelésű</option>
            <option value="PE70">70 °C – PE-szigetelésű</option>
            <option value="PAPER65">65 °C – Telített papírszigetelésű (6/10–12/20 kV)</option>
            <option value="PAPER60">60 °C – Telített papírszigetelésű (18/30–20,8/36 kV)</option>
          </select>
        </div>
        <div>
          <label for="soilT">Talaj hőmérséklete/Soil temp (°C)</label>
          <select id="soilT" title="Talaj hőmérséklete">
            <option>5</option><option>10</option><option>15</option><option>20</option><option>25</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="rho">Talaj fajlagos hőellenállása/Soil thermal resistivity</label>
          <select id="rho" title="Talaj fajlagos hőellenállása">
            <option>0.7</option><option>1.0</option><option>1.5</option><option>2.5</option>
          </select>
        </div>
        <div>
          <label for="lf">Terhelési tényező/Load factor</label>
          <select id="lf" title="Terhelési tényező">
            <option>0.50</option><option>0.60</option><option>0.70</option><option>0.85</option><option>1.00</option>
          </select>
        </div>
      </div>
      <hr />
      <div class="pill">3. f2 </div>
      <div class="row">
        <div>
          <label for="arr">Kábel elrendezés/Cable arrangement</label>
          <select id="arr" title="Kábel elrendezés az f2 táblázatok szerint">
            <option value="triangle7">Háromszögben, 7 cm</option>
            <option value="triangle25">Háromszögben, 25 cm</option>
            <option value="flat7">Síkban, 7 cm</option>
            <option value="3core">Háromerű kábel, síkban, 7 cm</option>
          </select>
        </div>
        <div>
          <label for="f2type">Kábel típusa/Cable type</label>
          <select id="f2type" title="Kábel típusa az f2 táblázatok szerint">
            <option value="XLPE">XLPE-szigetelésű</option>
            <option value="PE">PE-szigetelésű</option>
            <option value="PVC">PVC-szigetelésű</option>
           <option value="Paper">Telített papírszigetelésű</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="systems">Kábelrendszerek száma/Cable systems</label>
          <select id="systems" title="Kábelrendszerek száma">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>8</option><option>10</option>
          </select>
        </div>
        <div>
          <label for="rho2">Talaj fajlagos hőellenállása/Soil thermal resistivity</label>
          <select id="rho2" title="Talaj fajlagos hőellenállása az f2 számításhoz">
            <option>0.7</option><option>1.0</option><option>1.5</option><option>2.5</option>
          </select>
        </div>
      </div>
<!-- Terhelési tényező (még a 3. f2 rész része) -->
<div class="row">
  <div>
    <label for="lf2">Terhelési tényező/Load factor</label>
    <select id="lf2" title="Terhelési tényező az f2 számításhoz">
      <option>0.50</option><option>0.60</option><option>0.70</option><option>0.85</option><option>1.00</option>
    </select>
  </div>
</div>

<hr />

<!-- 4. pont: Védőcső -->
<div class="pill">4. Védőcső</div>
<div class="row">
  <div>
    <label for="duct">Védőcső/Protective conduit</label>
    <select id="duct" title="Ha van védőcső: 0,85-ös szorzó">
      <option value="no">Nem</option>
      <option value="yes">Igen (0,85×)</option>
    </select>
  </div>
</div>

<!-- Számítás gomb: külön blokkban, középen, kis térközzel -->
<div style="display:flex;justify-content:center;gap:8px;margin-top:16px">
  <button class="btn" id="calc">Számítás</button>
  <button class="btn" id="exportXlsx">XLSX export</button>
</div>




      <div class="note">Megjegyzés: f1-hez a 12.a / 12.b táblák, f2-höz a 13.a–16.b táblázatok adatait használjuk.</div>
    </section>
    <section class="card">
      <div class="pill">Számítás eredménye</div>
      <div style="display:grid; gap:8px; margin-top:8px;">
        <div><span class="muted">f1 érték</span><div class="mono" id="f1v">–</div></div>
        <div><span class="muted">f2 érték</span><div class="mono" id="f2v">–</div></div>
        <div><span class="muted">Végső terhelhetőség (A)</span><div class="big" id="total">—</div></div>
      </div>
      
      <div class="sources-actions">
  <a href="segedletek.html" class="btn" role="button">Segédletek</a>
</div>

    </section>
    <section class="card" id="system-card">
  <div class="pill">5. Rendszer adatai (opcionális)</div>

  <div class="row">
    <div>
      <label for="sysU">Névleges feszültség/Nominal voltage</label>
      <select id="sysU" title="Háromfázisú rendszer feszültsége (V)">
        <option value="">– válassz –</option>
        <option value="22000">22 kV</option>
        <option value="11000">11 kV</option>
        <option value="400">0,4 kV</option>
      </select>
    </div>
    <div>
      <label for="sysP">Teljesítmény/Power (kW)</label>
      <input id="sysP" type="number" min="0" step="0.1" placeholder="pl. 500" />
    </div>
  </div>

  <div class="muted" style="margin-top:8px">Háromfázisú képlet: <span class="mono">I = P / (√3 · U)</span></div>

  <div class="row" style="margin-top:8px">
    <div>
      <span class="muted">Áram/Current</span>
      <div class="mono" id="sysI">–</div>
    </div>
    <div>
      <span class="muted">Megfelelés/Rating check</span>
      <div class="mono" id="sysCheck">–</div>
    </div>
  </div>
</section>

  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script src="data/f1Data.js"></script>
<script src="data/f2Data.js"></script>

<script>
  if (typeof f1Data === 'undefined' || typeof f2Data === 'undefined') {
    alert('Hiányzik az adatfájl (f1Data/f2Data). Ellenőrizd a data/ könyvtárat és a <script> sorrendet!');
  }
</script>

  
  
<script>



  //------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


// ========== Segédfüggvények ==========

// a legközelebbi nagyobb/egyenlő kulcs (eredeti string kulccsal, pl. "1.0")
function findClosestKey(keys, value) {
  const rows = keys
    .map(k => ({ orig: k, val: (k === 'any' ? Infinity : parseFloat(k)) }))
    .sort((a, b) => a.val - b.val);

  const numVal = (typeof value === 'number') ? value : parseFloat(value);
  if (!rows.length || Number.isNaN(numVal)) return null;

  for (const row of rows) {
    if (numVal <= row.val) return row.orig;
  }
  return rows[rows.length - 1].orig;
}

// a legnagyobb, de <= value kulcs (eredeti string kulccsal), 'any' figyelmen kívül
function findFloorKey(keys, value) {
  const rows = keys
    .filter(k => k !== 'any')
    .map(k => ({ orig: k, val: parseFloat(k) }))
    .filter(r => !Number.isNaN(r.val))
    .sort((a,b) => a.val - b.val);

  const numVal = (typeof value === 'number') ? value : parseFloat(value);
  if (!rows.length || Number.isNaN(numVal)) return null;

  let candidate = null;
  for (const row of rows) {
    if (row.val <= numVal) candidate = row.orig; else break;
  }
  return candidate;
}

function getNested(obj, keys) {
  return keys.reduce((o,k) => (o && k in o) ? o[k] : null, obj);
}

// LF kulcs normalizálók
function lfKeyF1(n) {
  if (n === 1) return "1.00";
  if (n === 0.85) return "0.85";
  return n.toFixed(2); // "0.50", "0.60", "0.70"
}
function lfKeyF2(n) {
  if (n === 1) return "1.0";
  if (n === 0.85) return "0.85";
  return n.toString(); // "0.5","0.6","0.7"
}

// ========== f1 lekérés (szigorú, de ésszerű fallback) ==========
function getF1Value(type, soilT, rho, lf) {
  const temps = f1Data[type];
  if (!temps) return null;

  const tKey = findClosestKey(Object.keys(temps), Number(soilT));
  if (!tKey) return null;

  const rhoData = temps[tKey];

  // RHO: floor (25 °C-nál ha 0.7 nincs, ne ugorjunk fel 1.0-ról le/fel tévesen)
  const rKey = findFloorKey(Object.keys(rhoData), rho);
  if (!rKey) return null;

  const lfData = rhoData[rKey];

  // ha van "any", azt bármely LF-re visszaadjuk
  if ('any' in lfData) return lfData['any'];

  // pontos LF
  if (lf in lfData) return lfData[lf];

  // fallback: legnagyobb <= LF (f1-ben "0.50" formátum kell)
  const lfs = Object.keys(lfData).map(parseFloat).sort((a,b)=>a-b);
  const lfNum = parseFloat(lf);
  for (let i = lfs.length - 1; i >= 0; i--) {
    if (lfNum >= lfs[i]) {
      const key = lfKeyF1(lfs[i]);
      return lfData[key];
    }
  }
  return null;
}

// ========== f2 lekérés ==========
function getF2Value(arr, type, systems, rho, lf) {
  const table = f2Data[arr];
  if (!table) return null;

  const typeData = table[type];
  if (!typeData) return null;

  const sysKey = findFloorKey(Object.keys(typeData), systems);
  if (!sysKey) return null;

  const rhoData = typeData[sysKey];

  const rKey = findFloorKey(Object.keys(rhoData), rho);
  if (!rKey) return null;

  const lfData = rhoData[rKey];

  // pontos LF string
  if (lf in lfData) return lfData[lf];

  // normalizált LF kulcs ("0.50" -> "0.5")
  const lfNorm = lfKeyF2(parseFloat(lf));
  if (lfNorm in lfData) return lfData[lfNorm];

  // fallback: legnagyobb <= LF
  const lfs = Object.keys(lfData).map(parseFloat).sort((a,b)=>a-b);
  const lfNum = parseFloat(lf);
  for (let i = lfs.length - 1; i >= 0; i--) {
    if (lfNum >= lfs[i]) {
      const key = lfKeyF2(lfs[i]);
      return lfData[key];
    }
  }
  return null;
}

// ========== (opcionális) duplikált f2-k összeolvasztása ==========
["triangle7","triangle25","flat7","3core"].forEach(k => {
  const extra = f2Data[k + "b"];
  if (extra) {
    f2Data[k] = { ...(f2Data[k] || {}), ...extra };
    delete f2Data[k + "b"];
  }
});

// ========== Háromfázisú rendszeráram ==========
function computeSystemCurrent(U_volt, PkW) {
  if (!U_volt || !PkW || U_volt <= 0 || PkW < 0) return null;
  return (PkW * 1000) / (Math.sqrt(3) * U_volt);
}

// ========== DOM hivatkozások ==========
const $ = (id) => document.getElementById(id);

const elBase   = $('base');
const elF1t    = $('f1type');
const elSoilT  = $('soilT');
const elRho    = $('rho');
const elLf     = $('lf');

const elArr    = $('arr');
const elF2t    = $('f2type');
const elSys    = $('systems');
const elRho2   = $('rho2');
const elLf2    = $('lf2');
const elDuct   = $('duct');

const outF1    = $('f1v');
const outF2    = $('f2v');
const outTotal = $('total');

const elSysU   = $('sysU');
const elSysP   = $('sysP');
const outSysI  = $('sysI');
const outCheck = $('sysCheck');

const btnCalc  = $('calc');
const btnXlsx  = $('exportXlsx');

let lastResult = null;

// ========== Számítás + UI ==========
function performCalculationAndUpdateUI() {
  const base = Number(elBase.value);
  if (!base || base <= 0) {
    outF1.textContent = '–';
    outF2.textContent = '–';
    outTotal.textContent = 'Nem számolható az adott adatokkal';
    const Ionly = computeSystemCurrent(elSysU?.value, elSysP?.value);
    if (outSysI) outSysI.textContent = Ionly ? Ionly.toFixed(1) + ' A' : '–';
    if (outCheck) { outCheck.textContent = '–'; outCheck.className = 'mono'; }
    lastResult = null;
    return null;
  }

  const f1 = getF1Value(elF1t.value, elSoilT.value, elRho.value, elLf.value);
  const f2 = getF2Value(elArr.value, elF2t.value, elSys.value, elRho2.value, elLf2.value);

  outF1.textContent = (f1 == null) ? 'Nincs adat' : f1.toFixed(3);
  outF2.textContent = (f2 == null) ? 'Nincs adat' : f2.toFixed(3);

  if (f1 == null || f2 == null) {
    outTotal.textContent = 'Nem számolható az adott adatokkal';
    const Ionly = computeSystemCurrent(elSysU.value, elSysP.value);
    if (outSysI) outSysI.textContent = Ionly ? Ionly.toFixed(1) + ' A' : '–';
    if (outCheck) { outCheck.textContent = '–'; outCheck.className = 'mono'; }
    lastResult = { base, f1, f2, total: null, duct: elDuct?.value === 'yes',
                   sysU: elSysU.value, sysP: elSysP.value, I: Ionly, ok: null };
    return lastResult;
  }

  const ductFactor = (elDuct && elDuct.value === 'yes') ? 0.85 : 1.0;
  const total = base * f1 * f2 * ductFactor;
  outTotal.textContent = total.toFixed(1) + ' A';

  const I = computeSystemCurrent(elSysU.value, elSysP.value);
  if (outSysI) outSysI.textContent = I ? I.toFixed(1) + ' A' : '–';

  if (I && total) {
    if (total >= I) {
      outCheck.textContent = 'Kábel megfelelő';
      outCheck.className = 'mono ok';
    } else {
      outCheck.textContent = 'Kábel nem megfelelő';
      outCheck.className = 'mono bad';
    }
  } else {
    outCheck.textContent = '–';
    outCheck.className = 'mono';
  }

  lastResult = { base, f1, f2, total,
                 duct: elDuct?.value === 'yes',
                 sysU: elSysU.value, sysP: elSysP.value, I,
                 ok: (I && total) ? (total >= I) : null };
  return lastResult;
}

// ========== Események ==========
btnCalc?.addEventListener('click', performCalculationAndUpdateUI);
[elSysU, elSysP].forEach(el => el?.addEventListener('input', () => { if (lastResult) performCalculationAndUpdateUI(); }));

// ========== XLSX export ==========
btnXlsx?.addEventListener('click', () => {
  const res = performCalculationAndUpdateUI();
  if (!res) { alert('Először töltsd ki az adatokat és nyomd meg a Számítás gombot.'); return; }
  if (res.f1 == null || res.f2 == null) { alert('Ezekkel az adatokkal nem számolható.'); return; }

  const f1typeEl = elF1t, arrEl = elArr, f2typeEl = elF2t;
  const rows = [
    ['Projekt címe',''],
    ['Kábel fajtája',''],
    ['',''],
    ['Bemenetek','Érték'],
    ['Alapterhelhetőség (A)', res.base ?? '—'],
    ['f1 – Kábel típusa', f1typeEl.selectedOptions[0].text + ` [${f1typeEl.value}]`],
    ['f1 – Talaj hőmérséklete (°C)', elSoilT.value],
    ['f1 – Talaj fajlagos hőellenállása ρ', elRho.value],
    ['f1 – Terhelési tényező', elLf.value],
    ['f2 – Elrendezés', arrEl.selectedOptions[0].text + ` [${arrEl.value}]`],
    ['f2 – Kábel típusa', f2typeEl.selectedOptions[0].text + ` [${f2typeEl.value}]`],
    ['f2 – Kábelrendszerek száma', elSys.value],
    ['f2 – Talaj fajlagos hőellenállása ρ', elRho2.value],
    ['f2 – Terhelési tényező', elLf2.value],
    ['Védőcső', res.duct ? 'Igen (0,85×)' : 'Nem'],
    ['',''],
    ['Eredmények','Érték'],
    ['f1', res.f1.toFixed(3)],
    ['f2', res.f2.toFixed(3)],
    ['Végső terhelhetőség (A)', res.total == null ? 'Nem számolható' : res.total.toFixed(1)],
    ['',''],
    ['Rendszer adatai (opcionális)','Érték'],
    ['Névleges feszültség (V)', elSysU.value || '—'],
    ['Teljesítmény (kW)', elSysP.value || '—'],
    ['Számított rendszeráram (A)', res.I ? res.I.toFixed(1) : '—'],
    ['Összehasonlítás', res.ok == null ? '—' : (res.ok ? 'Kábel megfelelő' : 'Kábel nem megfelelő')],
    ['',''],
    ['Szabvány','MSZ 13207:2020'],
    ['Export dátum/idő', new Date().toLocaleString()],
  ];

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{ wch: 38 }, { wch: 28 }];
  XLSX.utils.book_append_sheet(wb, ws, 'Számítás');
  XLSX.writeFile(wb, `kabel_terheles_${Date.now()}.xlsx`);
});
</script>

</body>
</html>
